<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
	<script src="js/jquery-3.4.1.min.js"></script>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <script src="js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="css/style.css">
    <script>
        window.addEventListener('DOMContentLoaded', () => {
            const siteTable = [
                {
                    id: 1,
                    bu: "Wireline",
                    region: "Ontario - SWO",
                    province: "Ontario",
                    site: "New Dundee",
                    siteCode: "PG05",
                    clliCode: "NDNDONAF",
                    streetNumber: "2536 Bethel Rd. New Hamburg, Ontario N3A 2X7",
                    country: "Canada"
                },
                {
                    id: 2,
                    bu: "Wireline",
                    region: "Ontario - Simcoe",
                    province: "Ontario",
                    site: "Newkirk",
                    siteCode: "PONK1",
                    clliCode: "RMHLONAY",
                    streetNumber: "234 Newkirk Rd. Richmond Hill, Ontario L4C 3G7",
                    country: "Canada"
                },
                {
                    id: 3,
                    bu: "Wireline",
                    region: "Ontario - Simcoe",
                    province: "Ontario",
                    site: "Newmarket",
                    siteCode: "PN02",
                    clliCode: "NWMKONID",
                    streetNumber: "755 Old Bathurst St Newmarket, Ontario L3X 3A6",
                    country: "Canada"
                },
                {
                    id: 4,
                    bu: "Wireline",
                    region: "Atlantic",
                    province: "Newfoundland",
                    site: "Notre Dame",
                    siteCode: "PDND1",
                    clliCode: "LWTTNFBA",
                    streetNumber: "Miracle Temple Rd, Off Route 340, Notre Dame Junction Lewisporte, Newfoundland A0G 3A0",
                    country: "Canada"
                },
            ];
            const caTable = [
                {
                    id: 1,
                    ca: "26NW200972",
                    projectNumber: "309591",
                    projectName: "2026 SDE Resiliency",
                    projectOwner: "Dimitry Kisialeu",
                },
                {
                    id: 2,
                    ca: "26NW200972",
                    projectNumber: "309701",
                    projectName: "2026 SDE Resiliency",
                    projectOwner: "Dimitry Kisialeu",
                },
                {
                    id: 3,
                    ca: "26NW200978",
                    projectNumber: "309595",
                    projectName: "2026 SevOne Resiliency and Enhancement",
                    projectOwner: "Fahad Syed",
                },
                {
                    id: 4,
                    ca: "26NW200984",
                    projectNumber: "309904",
                    projectName: "Video Applications - Satellite",
                    projectOwner: "Ahmad Haydar",
                },
            ];
            const rcpcTable = [
                {
                    id: 1,
                    supplierPart: "N9K-C9508-FM-E2",
                    rcpc: "NC-N9K-C9508-FM-E2",
                    supplier: "CISCO SYSTEMS",
                    description: "Fabric Module, for N9508 with 100G support, ACI and NX-OS"
                },
                {
                    id: 2,
                    supplierPart: "N9K-PDC-3000W-B",
                    rcpc: "NC-N9K-PDC-3000W-B",
                    supplier: "CISCO SYSTEMS",
                    description: "Power Supply, Nexus 9500 3000W -48V DC PS, Port-side Intake"
                },
                {
                    id: 3,
                    supplierPart: "N9K-X9736C-FX3",
                    rcpc: "NC-N9K-X9736C-FX3",
                    supplier: "CISCO SYSTEMS",
                    description: "Line Card, Nexus 9500 36p 100G NX-OS Agg, ACI Spine, MACSec"
                },
                {
                    id: 4,
                    supplierPart: "N9K-X9788TC-FX",
                    rcpc: "NC-N9K-X9788TC-FX",
                    supplier: "CISCO SYSTEMS",
                    description: "Line Card, Nexus 9500 48p 1/10GBaseT and 4p 100G"
                },
                {
                    id: 5,
                    supplierPart: "XR-NC55A1R-K9-24.4",
                    rcpc: "NC-XR-NC55A1R-K9-24.4",
                    supplier: "CISCO SYSTEMS",
                    description: "Software, Cisco NCS 55A1 IOS XR 24.4 K9 Image for R-Phy Agg"
                },
                {
                    id: 6,
                    supplierPart: "MA-PWR-100WAC",
                    rcpc: "BAA640139",
                    supplier: "CISCO SYSTEMS",
                    description: "Power Adapter, Replacement for Meraki MX68, MX75"
                },
            ];
            let gProjectNumber = 0,
                gSiteCode = 0;
            const formMor = document.querySelector('#formMor'),
                morSite = formMor.querySelector('#mor_site'),
                morCA = formMor.querySelector('#mor_ca'),
                mor_ProjectName = formMor.querySelector('#mor_project_name'),
                morSiteAddress = formMor.querySelector('#mor_site_address'),
                morRegion = formMor.querySelector('#mor_region'),
                morCity = formMor.querySelector('#mor_city'),
                morProvince = formMor.querySelector('#mor_province'),
                morCountry = formMor.querySelector('#mor_country'),
                morApprovingMgr = formMor.querySelector('#mor_approving_mgr'),
                mor_project_contact = formMor.querySelector('#mor_project_contact'),
                morTable = formMor.querySelector('#mor_table'),
                morAddRow = formMor.querySelector('#js_mor_row_append'),
                //morPartList = formMor.querySelector('#mor-part-list'),
                //morVendorPart = formMor.querySelector('#js_vendor_part'),
                mor_requestor = formMor.querySelector('#mor_requestor');

            function rowParts (trId) {
                return `
                <tr class="js-mor-tr-dyn" data-tr-id="${trId}">
                    <td><input type="text" class="mor js-mor-rcpc" name="mor_rcpc[]" value="" required></td>
                    <td><input type="text" class="mor js-mor-vendor-name" name="mor_vendor_name[]" value="" required></td>
                    <td>
                        <div class="mor-vendor-part-container">
                            <input type="text" class="mor js_vendor_part" name="mor_vendor_part[]" value="">
                            <ul class="mor-part-autocomplete mor-part-list d-none"></ul>
                        </div>
                    </td>
                    <td><input type="text" class="mor js-mor-part-descr" name="mor_part_descr[]" value=""></td>
                    <td><input type="text" class="mor" name="mor_quantity[]" value="" required></td>
                    <td><input type="text" class="mor" name="mor_uom[]" value="EA" required></td>
                    <td><input type="text" class="mor js-mor-oracle" name="mor_oracle[]" value="" required readonly></td>
                    <td><input type="text" class="mor" name="mor_task[]" value="" required></td>
                    <td><input type="text" class="mor js-mor-site-code" name="mor_site_code[]" value="" required></td>
                    <td><input type="text" class="mor js-mor-date-required" name="mor_date_required[]" value="" required></td>
                    <td><input type="text" class="mor" name="mor_org[]" value=""></td>
                    <td><input type="text" class="mor" name="mor_supplier_notes[]" value=""></td>
                </tr>`;
            }
            
            mor_requestor.addEventListener('change', (e) => {
                if (mor_project_contact.value.trim() == '') {
                    mor_project_contact.value = e.target.value.trim();
                }
            });
            morSite.addEventListener('change', (e) => {
                const target = e.target;
                const id = parseInt(target.options[target.selectedIndex].dataset.id, 10);
                const siteIdx = siteTable.findIndex(site => site.id === id);
                morSiteAddress.value = siteTable[siteIdx].streetNumber;
                morCity.value = siteTable[siteIdx].site;
                morRegion.value = siteTable[siteIdx].region;
                morProvince.value = siteTable[siteIdx].province;
                morCountry.value = siteTable[siteIdx].country;
                gSiteCode = target.value;
            });
            morCA.addEventListener('change', (e) => {
                const target = e.target;
                const id = parseInt(target.options[target.selectedIndex].dataset.id, 10);
                const caIdx = caTable.findIndex(ca => ca.id === id);
                mor_ProjectName.value = caTable[caIdx].projectName;
                morApprovingMgr.value = caTable[caIdx].projectOwner;
                gProjectNumber = caTable[caIdx].projectNumber;
            });
            morAddRow.addEventListener('click', (e) => {
                if (gProjectNumber != 0 && gSiteCode != 0) {
                    const tbody = morTable.querySelector('TBODY');
                    if (tbody) {
                        let trId = (tbody.dataset.trId !== undefined) ? parseInt(tbody.dataset.trId, 10) : 1;
                        tbody.insertAdjacentHTML('beforeend', rowParts(trId));
                        tbody.dataset.trId = trId + 1;
                        const morTRDyn = tbody.querySelector(`.js-mor-tr-dyn[data-tr-id='${trId}']`);
                        if (morTRDyn) {
                            morTRDyn.querySelector('.js-mor-oracle').value = gProjectNumber;
                            morTRDyn.querySelector('.js-mor-site-code').value = gSiteCode;
                            const currentDate = new Date();
                            const formattedDate = currentDate.toISOString().split('T')[0];
                            morTRDyn.querySelector('.js-mor-date-required').value = formattedDate;
                        }
                    }
                }
            });

            morTable.addEventListener('input', (e) => {
                const target = e.target;
                const morTRDyn = target.closest('.js-mor-tr-dyn');
                if (morTRDyn) {
                    const morPartList = morTRDyn.querySelector('.mor-part-list');
                    if (target.classList.contains('js_vendor_part') && target.value.trim() != '') {
                        morPartList.textContent = '';
                        let partList = rcpcTable.filter(rcpc => rcpc.supplierPart.includes(target.value.trim().toUpperCase()));
                        partList.forEach(item => {
                            const li = document.createElement('li');
                            li.textContent = item.supplierPart;
                            li.dataset.id = item.id;
                            li.addEventListener('click', (e) => {
                                target.value = e.target.textContent;
                                //target.dataset.id = e.target.dataset.id;
                                const id = parseInt(e.target.dataset.id, 10);
                                const rcpcIdx = rcpcTable.findIndex(rcpc => rcpc.id === id);
                                morTRDyn.querySelector('.js-mor-rcpc').value = rcpcTable[rcpcIdx].rcpc;
                                morTRDyn.querySelector('.js-mor-vendor-name').value = rcpcTable[rcpcIdx].supplier;
                                morTRDyn.querySelector('.js-mor-part-descr').value = rcpcTable[rcpcIdx].description;
                                //morTRDyn.querySelector('.js-mor-oracle').value = gProjectNumber;
                                //morTRDyn.querySelector('.js-mor-site-code').value = gSiteCode;
                                //const currentDate = new Date();
                                //const formattedDate = currentDate.toISOString().split('T')[0];
                                //morTRDyn.querySelector('.js-mor-date-required').value = formattedDate;
                                
                                morPartList.classList.add('d-none'); 
                            });
                            morPartList.append(li);
                        });
                        morPartList.classList.remove('d-none');
                    } else {
                        morPartList.classList.add('d-none'); 
                    }
                }
            });

            morTable.addEventListener('click', (e) => {
                if (!e.target.classList.contains('js_vendor_part')) {
                    //morPartList.classList.add('d-none');
                }
            });

            morSite.textContent = '';
            morCA.textContent = '';
            formMor.reset();

            for (ca of caTable) {
                morCA.insertAdjacentHTML('beforeend', `
                    <OPTION value="${ca.ca}" data-id="${ca.id}">${ca.ca}</OPTION>
                `);
            };
            morCA.value = '';

            for (site of siteTable) {
                morSite.insertAdjacentHTML('beforeend', `
                    <OPTION value="${site.site}-${site.siteCode}" data-id="${site.id}">${site.site}-${site.siteCode}</OPTION>
                `);
            };
            morSite.value = '';
        });
    </script>
    <title>MOR</title>
</head>
<body>
    <form method="POST" action="classMor.php" id="formMor">   
        <table class="table table-sm table-bordered mor" id="mor_table">
						<tbody>
							<tr>
								<td colspan="4" class="center font-weight-bold fs-18">Project Information</td>
								<td colspan="8" class="center font-weight-bold fs-18">Shipping Details</td>
							</tr>
							<tr>
								<td colspan="2">Network Project (e.g. RPATS) #</td>
								<td class="mor-bg-rose" colspan="2">
									<select class="mor" name="mor_ca" id="mor_ca" required>
									</select>
								</td>
								<td class="font-weight-bold" rowspan="8">Ship to Address</td>
								<td>Contact Name</td>
								<td class="mor-bg-rose" colspan="6">
									<input type="text" class="mor" name="mor_project_contact" id="mor_project_contact" value="" required>
								</td>
							</tr>
							<tr>
								<td colspan="2">Network Project Name</td>
								<td class="mor-bg-rose" colspan="2">
									<input type="text" class="mor" name="mor_project_name" id="mor_project_name" value="" required>
								</td>
								<td>Phone Number</td>
								<td class="mor-bg-rose" colspan="6">
									<input type="tel" class="mor" name="mor_phone_number" id="mor_phone_number" pattern= "[0-9]{2,}" value="" required>
								</td>
							</tr>
							<tr>
								<td colspan="2">Project Manager</td>
								<td class="mor-bg-rose" colspan="2">
									<input type="text" class="mor" name="mor_project_manager" id="mor_project_manager" value="" required>
								</td>
								<td>Street Number</td>
								<td class="mor-bg-rose" colspan="6">
									<input type="text" class="mor" name="mor_site_address" id="mor_site_address" value="" required>
								</td>
							</tr>
							<tr>
								<td colspan="2">Site Name / Address</td>
								<td class="mor-bg-rose" colspan="2">
									<select class="mor" name="mor_site" id="mor_site">
									</select>
								</td>
								<td>Street Name</td>
								<td class="mor-bg-rose" colspan="6">
									<input type="text" class="mor" name="mor_site_address2" id="mor_site_address2" value="" required>
								</td>
							</tr>
							<tr>
								<td colspan="2">Date Submitted (YYYY-MM-DD)</td>
								<td class="mor-bg-rose" colspan="2">
									<input type="text" class="mor" id="mor_date" name="mor_date" value="" required>
								</td>
								<td>City</td>
								<td class="mor-bg-rose" colspan="6">
									<input type="text" class="mor" name="mor_city" id="mor_city" value="" required>
								</td>
							</tr>
							<tr>
								<td colspan="2">Requestor/Planner</td>
								<td class="mor-bg-rose" colspan="2">
									<input type="text" class="mor" name="mor_requestor" id="mor_requestor" value="" required>
								</td>
								<td>Province</td>
								<td class="mor-bg-rose" colspan="6">
									<input type="text" class="mor" name="mor_province" id="mor_province" value="" required>
								</td>
							</tr>
							<tr>
								<td colspan="2">Region / Area</td>
								<td class="mor-bg-rose" colspan="2">
									<input type="text" class="mor" name="mor_region" id="mor_region" value="" required>
								</td>
								<td>Postal Code (XXX XXX)</td>
								<td class="mor-bg-rose" colspan="6">
									<input type="text" class="mor" name="mor_postal_code" id="mor_postal_code" value="" required>
								</td>
							</tr>
							<tr>
								<td colspan="2">Requisition / PO Number <span class="font-weight-bold text-danger">(comma seperated)</span></td>
								<td class="mor-bg-lellow" colspan="2">
									<input type="text" class="mor" name="mor_requisition" id="mor_requisition" value="">
								</td>
								<td>Country</td>
								<td class="mor-bg-rose" colspan="6">
									<input type="text" class="mor" name="mor_country" id="mor_country" value="" required>
								</td>
							</tr>
							<tr>
								<td colspan="2" rowspan="3">Additional Information / Approver Notes</td>
								<td class="mor-bg-lellow" colspan="2" rowspan="3">
									<textarea class="mor" name="mor_add-info" id="mor_add-info" cols="20" rows="3"></textarea>
								</td>
								<td colspan="2">Contractor</td>
								<td class="mor-bg-lellow" colspan="6">
									<input type="text" class="mor" name="mor_contractor" id="mor_contractor" value="N/A">
								</td>
							</tr>
							<tr>
								<td colspan="2">Drop Ship</td>
								<td class="mor-bg-lellow" colspan="6">
									<input type="text" class="mor" name="mor_drop_ship" id="mor_drop_ship" value="Yes">
								</td>
							</tr>
							<tr>
								<td colspan="2">Approving Mgr <span class="font-weight-bold text-danger">(semi-colon seperated)</span></td>
								<td class="mor-bg-lellow" colspan="6">
									<input type="text" class="mor" name="mor_approving_mgr" id="mor_approving_mgr" value="">
								</td>
							</tr>
							<tr class="thead">
								<td colspan="12">Material Planner</td>
							</tr>
							<tr>
								<td class="center" colspan="2">Completed Sales Order #</td>
								<td colspan="2">&nbsp;</td>
								<td class="center" colspan="2">Completed Requisition #</td>
								<td colspan="6">&nbsp;</td>
							</tr>
							<tr>
								<td colspan="12" class="font-weight-bold center fs-18">C. Part Details 
									<button class="mor action" id="js_mor_row_append" type="button" title="Add row">+</button>
								</td>
							</tr>
							<tr class="thead">
								<td class="mor-bg-rose">RCPC</td>
								<td class="mor-bg-rose">Vendor Name</td>
								<td class="mor-bg-lellow">Vendor Part #</td>
								<td class="mor-bg-lellow">Part Description</td>
								<td class="mor-bg-rose">Quantity</td>
								<td class="mor-bg-rose">UOM</td>
								<td class="mor-bg-rose">Oracle #</td>
								<td class="mor-bg-rose">Task #</td>
								<td class="mor-bg-rose">Site Code</td>
								<td class="mor-bg-rose">Date Required (YYYY-MM-DD)</td>
								<td>Org (MRF Only)</td>
								<td>Supplier Notes (Filled by Material Planner)</td>
							</tr>
						</tbody>
					</table>
        <div class="buttons">
            <button class="mop" type="submit" id="morSubmit">Create</button>
            <button class="mop" type="reset" id="morReset">Reset</button>
        </div>
    </form>
</body>
</html>